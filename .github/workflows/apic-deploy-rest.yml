name: APIC Deploy via REST

on:
  workflow_dispatch:
    inputs:
      api_file:
        description: "Path to API YAML"
        default: "apis/hello-proxy.yaml"
        required: true
      product_file:
        description: "Path to Product YAML (optional)"
        default: "products/hello-product.yaml"
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APIC_BASE: ${{ secrets.APIC_BASE }}        # e.g. https://<env>.../manager
      APIC_USERNAME: ${{ secrets.APIC_USERNAME }}
      APIC_PASSWORD: ${{ secrets.APIC_PASSWORD }}
      APIC_ORG: ${{ secrets.APIC_ORG }}          # e.g. try-ai
      APIC_CATALOG: ${{ secrets.APIC_CATALOG }}  # e.g. sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show inputs
        run: |
          echo "API:     ${{ github.event.inputs.api_file }}"
          echo "Product: ${{ github.event.inputs.product_file }}"

      # üîê Authenticate with APIC (Basic or Cookie mode)
      - name: Get APIC auth (basic/cookie)
        id: auth
        run: |
          set -euo pipefail
          BASE="${APIC_BASE}"
          USER="${APIC_USERNAME}"
          PASS="${APIC_PASSWORD}"

          echo "üîé Checking Basic authentication..."
          STATUS=$(curl -sk -o /dev/null -w "%{http_code}" -u "$USER:$PASS" "$BASE/api/orgs")
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Using Basic authentication"
            echo "mode=basic" >> $GITHUB_OUTPUT
            echo "curl_auth=-u '${USER}:${PASS}'" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üîé Trying Cookie-based authentication..."
          COOKIE=/tmp/apic_cookie.txt
          LOGIN_STATUS=$(curl -sk -o /dev/null -w "%{http_code}" \
            -c "$COOKIE" -b "$COOKIE" \
            -X POST "$BASE/login" \
            -H 'Content-Type: application/json' \
            --data "{\"username\":\"$USER\",\"password\":\"$PASS\"}")

          if [ "$LOGIN_STATUS" = "200" ] || [ "$LOGIN_STATUS" = "204" ]; then
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" -c "$COOKIE" -b "$COOKIE" "$BASE/api/orgs")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Using Cookie authentication"
              echo "mode=cookie" >> $GITHUB_OUTPUT
              echo "cookie_path=$COOKIE" >> $GITHUB_OUTPUT
              echo "curl_auth=-c '$COOKIE' -b '$COOKIE'" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "::error::Authentication failed (basic and cookie both failed). Check APIC_BASE/credentials."
          exit 1

      - name: Install yq (YAML parser)
        run: |
          set -euo pipefail
          VERSION="v4.44.3"
          curl -fsSL "https://github.com/mikefarah/yq/releases/download/${VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          yq --version

      # üß© Create/Update Draft API (tries both endpoint shapes + PUT fallback)
      - name: Create/Update Draft API (with fallbacks)
        run: |
          set -euo pipefail
          API_FILE="${{ github.event.inputs.api_file }}"
          NAME=$(yq -r '.info.name // .info.title // .title' "$API_FILE")
          VER=$(yq -r '.info.version' "$API_FILE")
          echo "üì¶ API file: $API_FILE"
          echo "üîñ Parsed name: $NAME, version: $VER"

          EP1="${APIC_BASE}/api/orgs/${APIC_ORG}/drafts/draft-apis?replace=true"
          EP2="${APIC_BASE}/api/orgs/${APIC_ORG}/drafts/apis?replace=true"
          EP3="${APIC_BASE}/api/orgs/${APIC_ORG}/drafts/apis/${NAME}:${VER}"

          post_yaml() {
            local url="$1"
            curl -sk -o /tmp/draft-api.json -w "%{http_code}" \
              -X POST ${{ steps.auth.outputs.curl_auth }} \
              -H "Content-Type: application/yaml" \
              --data-binary @"$API_FILE" \
              "$url"
          }

          put_yaml() {
            local url="$1"
            curl -sk -o /tmp/draft-api.json -w "%{http_code}" \
              -X PUT ${{ steps.auth.outputs.curl_auth }} \
              -H "Content-Type: application/yaml" \
              --data-binary @"$API_FILE" \
              "$url"
          }

          echo "‚û°Ô∏è  Trying POST $EP1"
          CODE=$(post_yaml "$EP1")
          if [[ "$CODE" == "200" || "$CODE" == "201" ]]; then
            echo "‚úÖ Draft API Created/Updated via draft-apis"
            jq . /tmp/draft-api.json
            exit 0
          fi
          echo "‚ö†Ô∏è  POST $EP1 returned $CODE"

          echo "‚û°Ô∏è  Trying POST $EP2"
          CODE=$(post_yaml "$EP2")
          if [[ "$CODE" == "200" || "$CODE" == "201" ]]; then
            echo "‚úÖ Draft API Created/Updated via apis"
            jq . /tmp/draft-api.json
            exit 0
          fi
          echo "‚ö†Ô∏è  POST $EP2 returned $CODE"

          echo "‚û°Ô∏è  Trying PUT $EP3"
          CODE=$(put_yaml "$EP3")
          if [[ "$CODE" == "200" || "$CODE" == "201" || "$CODE" == "204" ]]; then
            echo "‚úÖ Draft API Updated via PUT"
            jq . /tmp/draft-api.json || true
            exit 0
          fi

          echo "::error::All draft API endpoints failed (last code: $CODE)."
          echo "Last response:"; cat /tmp/draft-api.json || true
          exit 1

      # üì¶ Create/Update Draft Product (tries both endpoint shapes + PUT fallback)
      - name: Create/Update Draft Product (optional, with fallbacks)
        if: ${{ github.event.inputs.product_file != '' }}
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          NAME=$(yq -r '.info.name // .info.title // .title' "$PRODUCT_FILE")
          VER=$(yq -r '.info.version' "$PRODUCT_FILE")
          echo "üì¶ Product file: $PRODUCT_FILE"
          echo "üîñ Parsed name: $NAME, version: $VER"

          EP1="${APIC_BASE}/api/orgs/${APIC_ORG}/drafts/draft-products?replace=true"
          EP2="${APIC_BASE}/api/orgs/${APIC_ORG}/drafts/products?replace=true"
          EP3="${APIC_BASE}/api/orgs/${APIC_ORG}/drafts/products/${NAME}:${VER}"

          post_yaml() {
            local url="$1"
            curl -sk -o /tmp/draft-product.json -w "%{http_code}" \
              -X POST ${{ steps.auth.outputs.curl_auth }} \
              -H "Content-Type: application/yaml" \
              --data-binary @"$PRODUCT_FILE" \
              "$url"
          }

          put_yaml() {
            local url="$1"
            curl -sk -o /tmp/draft-product.json -w "%{http_code}" \
              -X PUT ${{ steps.auth.outputs.curl_auth }} \
              -H "Content-Type: application/yaml" \
              --data-binary @"$PRODUCT_FILE" \
              "$url"
          }

          echo "‚û°Ô∏è  Trying POST $EP1"
          CODE=$(post_yaml "$EP1")
          if [[ "$CODE" == "200" || "$CODE" == "201" ]]; then
            echo "‚úÖ Draft Product Created/Updated via draft-products"
            jq . /tmp/draft-product.json
            exit 0
          fi
          echo "‚ö†Ô∏è  POST $EP1 returned $CODE"

          echo "‚û°Ô∏è  Trying POST $EP2"
          CODE=$(post_yaml "$EP2")
          if [[ "$CODE" == "200" || "$CODE" == "201" ]]; then
            echo "‚úÖ Draft Product Created/Updated via products"
            jq . /tmp/draft-product.json
            exit 0
          fi
          echo "‚ö†Ô∏è  POST $EP2 returned $CODE"

          echo "‚û°Ô∏è  Trying PUT $EP3"
          CODE=$(put_yaml "$EP3")
          if [[ "$CODE" == "200" || "$CODE" == "201" || "$CODE" == "204" ]]; then
            echo "‚úÖ Draft Product Updated via PUT"
            jq . /tmp/draft-product.json || true
            exit 0
          fi

          echo "::error::All draft Product endpoints failed (last code: $CODE)."
          echo "Last response:"; cat /tmp/draft-product.json || true
          exit 1

      # üöÄ Publish Product to Catalog
      - name: Publish Product to catalog (contains the API)
        if: ${{ github.event.inputs.product_file != '' }}
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          PUB_URL="${APIC_BASE}/api/catalogs/${APIC_ORG}/${APIC_CATALOG}/products?stage=true"
          echo "üöÄ Publishing Product to catalog: ${APIC_CATALOG}"
          curl -fsS -X POST ${{ steps.auth.outputs.curl_auth }} \
            -H "Content-Type: application/yaml" \
            --data-binary @"$PRODUCT_FILE" \
            "$PUB_URL" -o /tmp/publish.json
          echo "‚úÖ Product Published:"
          cat /tmp/publish.json | jq .

      # üöÄ Publish API directly if no Product provided
      - name: Publish API directly (if no product)
        if: ${{ github.event.inputs.product_file == '' }}
        run: |
          set -euo pipefail
          API_FILE="${{ github.event.inputs.api_file }}"
          PUB_URL="${APIC_BASE}/api/catalogs/${APIC_ORG}/${APIC_CATALOG}/apis?stage=true"
          echo "üöÄ Publishing API directly to catalog: ${APIC_CATALOG}"
          curl -fsS -X POST ${{ steps.auth.outputs.curl_auth }} \
            -H "Content-Type: application/yaml" \
            --data-binary @"${API_FILE}" \
            "$PUB_URL" -o /tmp/api-publish.json
          echo "‚úÖ API Published:"
          cat /tmp/api-publish.json | jq .
