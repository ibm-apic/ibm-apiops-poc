name: APIC Deploy via Toolkit (SaaS-ready)

on:
  workflow_dispatch:
    inputs:
      api_file:
        description: "Path to API YAML"
        default: "apis/hello-proxy.yaml"
        required: true
      product_file:
        description: "Path to Product YAML"
        default: "products/hello-product.yaml"
        required: true

jobs:
  deploy:
    name: Deploy draft API & Product, then publish
    runs-on: ubuntu-latest

    env:
      # Manager base (e.g. https://envxxxxx.a-vir-c1.apiconnect.ipaas.automation.ibm.com/manager)
      APIC_BASE:     ${{ secrets.APIC_BASE }}
      # SaaS: provider org name (e.g. env9559876)
      APIC_ORG:      ${{ secrets.APIC_ORG }}
      APIC_CATALOG:  ${{ secrets.APIC_CATALOG }}

      # SaaS API-key auth (recommended)
      APIC_PLATFORM_API: ${{ secrets.APIC_PLATFORM_API }}
      APIC_APIKEY:       ${{ secrets.APIC_APIKEY }}

      # Optional legacy/basic (for on-prem only). Will be ignored on SaaS.
      APIC_USERNAME: ${{ secrets.APIC_USERNAME }}
      APIC_PASSWORD: ${{ secrets.APIC_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Guard required secrets
        shell: bash
        run: |
          set -euo pipefail
          miss=""
          for v in APIC_BASE APIC_ORG APIC_CATALOG; do [ -n "${!v:-}" ] || miss="$miss $v"; done
          if [ -n "${miss}" ]; then echo "::error::Missing env: $miss"; exit 1; fi
          if [ -z "${APIC_APIKEY:-}" ] || [ -z "${APIC_PLATFORM_API:-}" ]; then
            echo "::warning::APIC_APIKEY/APIC_PLATFORM_API not set -> will try username/password (on-prem only). SaaS will FAIL."
          fi

      - name: Install APIC Toolkit from repo file
        id: tk
        shell: bash
        run: |
          set -euo pipefail
          TAR="toolkit/toolkit-linux.tgz"
          if [ ! -s "$TAR" ]; then
            echo "::error::Expected $TAR in repo."
            exit 1
          fi
          APIC_HOME="$(mktemp -d)/apic-toolkit"
          mkdir -p "$APIC_HOME"
          tar -xzf "$TAR" -C "$APIC_HOME"

          # find apic + apic-slim
          for CAND in "$APIC_HOME/apic" "$APIC_HOME/bin/apic"; do
            [ -x "$CAND" ] && APIC_BIN="$CAND"
          done
          for CAND in "$APIC_HOME/apic-slim" "$APIC_HOME/bin/apic-slim"; do
            [ -x "$CAND" ] && APIC_SLIM="$CAND"
          done
          if [ -z "${APIC_BIN:-}" ]; then
            echo "::error::Could not find 'apic' in toolkit"
            find "$APIC_HOME" -maxdepth 2 -type f -name 'apic*' -printf '%p\n' || true
            exit 1
          fi
          echo "$(dirname "$APIC_BIN")" >> "$GITHUB_PATH"
          echo "APIC_HOME=$APIC_HOME"   >> "$GITHUB_ENV"
          echo "APIC_BIN=$APIC_BIN"     >> "$GITHUB_ENV"
          echo "APIC_SLIM=${APIC_SLIM:-}" >> "$GITHUB_ENV"

          "$APIC_BIN" --accept-license version
          echo "âœ… Toolkit ready. apic: $APIC_BIN  apic-slim: ${APIC_SLIM:-<none>}"

      - name: Normalize APIC server URL
        id: norm
        shell: bash
        run: |
          set -euo pipefail
          # APIC_BASE is like https://env9559876.a-vir-c1.apiconnect.ipaas.automation.ibm.com/manager
          RAW="${APIC_BASE%/}"
          MGMT_BASE="${RAW%/manager}"           # strip trailing /manager for CLI server
          echo "MGMT_BASE=${MGMT_BASE}" >> "$GITHUB_ENV"
          echo "Using MGMT_BASE: ${MGMT_BASE}"
          echo "Using PLATFORM_API: ${APIC_PLATFORM_API}"

      - name: Login (prefer API key; supports no-apic-slim tar)
        shell: bash
        run: |
          set -euo pipefail
          REALM="provider/${APIC_ORG}"

          if [ -n "${APIC_APIKEY:-}" ] && [ -n "${APIC_PLATFORM_API:-}" ]; then
            echo "ðŸ” SaaS login with API key"
            apic login --sso --context provider \
              --server  "${APIC_PLATFORM_API}" \
              --apiKey  "${APIC_APIKEY}" \
              --accept-license
            # Sanity check (non-fatal) against MGMT_BASE (no /manager)
            apic orgs:list --server "${MGMT_BASE}" --accept-license | head -n 10 >/dev/null || true
            echo "âœ… Logged in with API key."
          else
            echo "ðŸ§ª Falling back to user/password (on-prem only)"
            apic login \
              --server   "${MGMT_BASE}" \
              --username "${APIC_USERNAME}" \
              --password "${APIC_PASSWORD}" \
              --realm    "${REALM}" \
              --accept-license
            echo "âœ… Logged in with user/password."
          fi


      - name: Push draft API (create or update)
        shell: bash
        run: |
          set -euo pipefail
          API_FILE="${{ github.event.inputs.api_file }}"
          [ -s "$API_FILE" ] || { echo "::error::Missing $API_FILE"; exit 1; }
          if ! apic drafts:apis:create "$API_FILE" \
                --server "${MGMT_BASE}" --org "${APIC_ORG}" --accept-license ; then
            apic drafts:apis:update "$API_FILE" \
                --server "${MGMT_BASE}" --org "${APIC_ORG}" --accept-license
          fi
          echo "âœ… Draft API upserted."

      - name: Push draft Product (create or update)
        shell: bash
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          [ -s "$PRODUCT_FILE" ] || { echo "::error::Missing $PRODUCT_FILE"; exit 1; }
          if ! apic drafts:products:create "$PRODUCT_FILE" \
                --server "${MGMT_BASE}" --org "${APIC_ORG}" --accept-license ; then
            apic drafts:products:update "$PRODUCT_FILE" \
                --server "${MGMT_BASE}" --org "${APIC_ORG}" --accept-license
          fi
          echo "âœ… Draft Product upserted."

      - name: Publish product to catalog (stage)
        shell: bash
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          apic products:publish "$PRODUCT_FILE" \
            --server  "${BASE}" \
            --org     "${APIC_ORG}" \
            --catalog "${APIC_CATALOG}" \
            --stage \
            --accept-license
          echo "ðŸŽ‰ Product published to '${APIC_CATALOG}' (staged)."
