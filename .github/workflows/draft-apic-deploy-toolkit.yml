name: APIC Deploy via Toolkit

on:
  workflow_dispatch:
    inputs:
      api_file:
        description: "Path to API YAML"
        default: "apis/hello-proxy.yaml"
        required: true
      product_file:
        description: "Path to Product YAML"
        default: "products/hello-product.yaml"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APIC_BASE:     ${{ secrets.APIC_BASE }}
      APIC_USERNAME: ${{ secrets.APIC_USERNAME }}
      APIC_PASSWORD: ${{ secrets.APIC_PASSWORD }}
      APIC_ORG:      ${{ secrets.APIC_ORG }}
      APIC_CATALOG:  ${{ secrets.APIC_CATALOG }}

    steps:
      - uses: actions/checkout@v4

      - name: Guard required secrets
        run: |
          set -euo pipefail
          for v in APIC_BASE APIC_USERNAME APIC_PASSWORD APIC_ORG APIC_CATALOG; do
            test -n "${!v:-}" || { echo "::error::Missing env $v"; exit 1; }
          done
          test -f toolkit/toolkit-linux.tgz || { echo "::error::Missing toolkit/toolkit-linux.tgz"; exit 1; }

      - name: Install APIC Toolkit (from repo file)
        id: toolkit
        run: |
          set -euo pipefail
          APIC_HOME="${RUNNER_TEMP}/apic-toolkit"
          mkdir -p "$APIC_HOME"
          tar -xzf toolkit/toolkit-linux.tgz -C "$APIC_HOME"

          if [ -x "${APIC_HOME}/apic" ]; then
            BIN="${APIC_HOME}"
          elif [ -x "${APIC_HOME}/bin/apic" ]; then
            BIN="${APIC_HOME}/bin"
          else
            echo "::error::Could not find apic binary"; find "$APIC_HOME" -name apic; exit 1
          fi

          echo "$BIN" >> "$GITHUB_PATH"
          echo "APIC_HOME=$APIC_HOME" >> "$GITHUB_ENV"
          apic --accept-license version

      - name: Normalize APIC server
        id: norm
        run: |
          set -euo pipefail
          S="${APIC_BASE%/}"
          S="${S%/manager}"
          echo "server=$S" >> "$GITHUB_OUTPUT"
          echo "Normalized server: $S"

      - name: Detect correct Realm (auto)
        id: realm
        run: |
          set -euo pipefail
          # Try listing available IDPs
          echo "ðŸ” Detecting valid realm from ${{ steps.norm.outputs.server }}..."
          OUT=$(curl -sk -u "${APIC_USERNAME}:${APIC_PASSWORD}" \
            "${{ steps.norm.outputs.server }}/api/cloud/settings/identity-providers" || true)
          echo "$OUT" | jq .
          REALM=$(echo "$OUT" | jq -r '.[0].name // empty')
          if [ -z "$REALM" ]; then
            echo "::warning::Could not auto-detect realm, defaulting to provider/default-idp"
            REALM="default-idp"
          fi
          echo "realm=provider/${REALM}" >> "$GITHUB_OUTPUT"
          echo "âœ… Using realm: provider/${REALM}"

      - name: Login to APIC
        run: |
          set -euo pipefail
          apic login \
            --server  "${{ steps.norm.outputs.server }}" \
            --username "${APIC_USERNAME}" \
            --password "${APIC_PASSWORD}" \
            --realm    "${{ steps.realm.outputs.realm }}" \
            --accept-license

      - name: Push draft API (create or update)
        run: |
          set -euo pipefail
          API_FILE="${{ github.event.inputs.api_file }}"
          if ! apic drafts:apis:create "${API_FILE}" \
                --server "${{ steps.norm.outputs.server }}" \
                --org "${APIC_ORG}" --accept-license ; then
            apic drafts:apis:update "${API_FILE}" \
                --server "${{ steps.norm.outputs.server }}" \
                --org "${APIC_ORG}" --accept-license
          fi

      - name: Push draft Product (create or update)
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          if ! apic drafts:products:create "${PRODUCT_FILE}" \
                --server "${{ steps.norm.outputs.server }}" \
                --org "${APIC_ORG}" --accept-license ; then
            apic drafts:products:update "${PRODUCT_FILE}" \
                --server "${{ steps.norm.outputs.server }}" \
                --org "${APIC_ORG}" --accept-license
          fi

      - name: Publish product to catalog (stage)
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          apic products:publish "${PRODUCT_FILE}" \
            --server "${{ steps.norm.outputs.server }}" \
            --org "${APIC_ORG}" \
            --catalog "${APIC_CATALOG}" \
            --stage \
            --accept-license
