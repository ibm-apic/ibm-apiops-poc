name: APIC Deploy via Toolkit (SaaS / repo toolkit)

on:
  workflow_dispatch:
    inputs:
      api_file:
        description: "Path to API YAML"
        default: "apis/hello-proxy.yaml"
        required: true
      product_file:
        description: "Path to Product YAML"
        default: "products/hello-product.yaml"
        required: true

jobs:
  deploy:
    name: Deploy draft API & Product, then publish
    runs-on: ubuntu-latest

    env:
      APIC_BASE:     ${{ secrets.APIC_BASE }}      # e.g. https://envxxxxx.a-vir-c1.apiconnect.ipaas.automation.ibm.com/manager
      APIC_USERNAME: ${{ secrets.APIC_USERNAME }}
      APIC_PASSWORD: ${{ secrets.APIC_PASSWORD }}
      APIC_ORG:      ${{ secrets.APIC_ORG }}       # e.g. env9559876
      APIC_CATALOG:  ${{ secrets.APIC_CATALOG }}   # e.g. sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Guard required secrets
        shell: bash
        run: |
          set -euo pipefail
          for v in APIC_BASE APIC_USERNAME APIC_PASSWORD APIC_ORG APIC_CATALOG; do
            if [ -z "${!v:-}" ]; then
              echo "::error title=Missing secret::Env var '$v' is empty/missing"
              exit 1
            fi
          done
          echo "âœ… Secrets present."

      - name: Install APIC Toolkit from repo file
        id: tk
        shell: bash
        run: |
          set -euo pipefail
          TAR="toolkit/toolkit-linux.tgz"
          if [ ! -s "$TAR" ]; then
            echo "::error title=Toolkit missing::Expected $TAR in repo. Please upload your APIC toolkit tarball there."
            exit 1
          fi

          APIC_HOME="$(mktemp -d)/apic-toolkit"
          mkdir -p "$APIC_HOME"
          tar -xzf "$TAR" -C "$APIC_HOME"

          if   [ -x "${APIC_HOME}/apic" ]; then BIN="${APIC_HOME}/apic"
          elif [ -x "${APIC_HOME}/bin/apic" ]; then BIN="${APIC_HOME}/bin/apic"
          else
            echo "::group::Toolkit contents"
            find "$APIC_HOME" -maxdepth 2 -type f | sed 's/^/ - /'
            echo "::endgroup::"
            echo "::error title=apic not found::Could not locate 'apic' binary in extracted toolkit."
            exit 1
          fi

          echo "$(dirname "$BIN")" >> "$GITHUB_PATH"
          echo "APIC_BIN=$BIN" >> "$GITHUB_ENV"
          echo "APIC_HOME=$APIC_HOME" >> "$GITHUB_ENV"

          "$BIN" --accept-license version
          echo "âœ… Toolkit installed at $APIC_HOME"

      - name: Normalize APIC server URL
        id: norm
        shell: bash
        run: |
          set -euo pipefail
          BASE="${APIC_BASE%/}"
          echo "BASE=$BASE" >> "$GITHUB_ENV"
          echo "Using Manager base: $BASE"

      - name: Login to APIC (realm = provider/${APIC_ORG})
        shell: bash
        run: |
          set -euo pipefail
          REALM="provider/${APIC_ORG}"
          echo "Using realm: $REALM"
          apic login \
            --server   "${BASE}" \
            --username "${APIC_USERNAME}" \
            --password "${APIC_PASSWORD}" \
            --realm    "${REALM}" \
            --accept-license

          apic orgs:list --server "${BASE}" --accept-license | head -n 20 || true
          echo "âœ… Logged in."

      - name: Push draft API (create or update)
        shell: bash
        run: |
          set -euo pipefail
          API_FILE="${{ github.event.inputs.api_file }}"
          if [ ! -s "$API_FILE" ]; then
            echo "::error title=Missing API file::$API_FILE not found"
            exit 1
          fi
          if ! apic drafts:apis:create "$API_FILE" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license ; then
            apic drafts:apis:update "$API_FILE" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license
          fi
          echo "âœ… Draft API upserted."

      - name: Push draft Product (create or update)
        shell: bash
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          if [ ! -s "$PRODUCT_FILE" ]; then
            echo "::error title=Missing Product file::$PRODUCT_FILE not found"
            exit 1
          fi
          if ! apic drafts:products:create "$PRODUCT_FILE" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license ; then
            apic drafts:products:update "$PRODUCT_FILE" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license
          fi
          echo "âœ… Draft Product upserted."

      - name: Publish product to catalog (stage)
        shell: bash
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          apic products:publish "$PRODUCT_FILE" \
            --server  "${BASE}" \
            --org     "${APIC_ORG}" \
            --catalog "${APIC_CATALOG}" \
            --stage \
            --accept-license
          echo "ðŸŽ‰ Product published to '${APIC_CATALOG}' (staged)."
