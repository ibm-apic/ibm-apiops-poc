name: APIC Deploy via Toolkit

on:
  workflow_dispatch:
    inputs:
      api_file:
        description: "Path to API YAML"
        default: "apis/hello-proxy.yaml"
        required: true
      product_file:
        description: "Path to Product YAML"
        default: "products/hello-product.yaml"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # e.g. https://envxxxxx.a-vir-c1.apiconnect.ipaas.automation.ibm.com/manager
      APIC_BASE:     ${{ secrets.APIC_BASE }}
      APIC_USERNAME: ${{ secrets.APIC_USERNAME }}
      APIC_PASSWORD: ${{ secrets.APIC_PASSWORD }}
      APIC_ORG:      ${{ secrets.APIC_ORG }}
      APIC_CATALOG:  ${{ secrets.APIC_CATALOG }}
      # Use the realm you validated in the UI (provider/default-idp is common on SaaS)
      APIC_REALM:    ${{ secrets.APIC_REALM || 'provider/env9559876' }}

    steps:
      - uses: actions/checkout@v4

      - name: Guard required secrets
        run: |
          set -euo pipefail
          for v in APIC_BASE APIC_USERNAME APIC_PASSWORD APIC_ORG APIC_CATALOG; do
            [ -n "${!v:-}" ] || { echo "::error::Missing env $v"; exit 1; }
          done

      - name: Install APIC Toolkit (from repo file)
        id: tk
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ“¦ Installing IBM API Connect Toolkit from toolkit/toolkit-linux.tgz ..."
          APIC_HOME="${RUNNER_TEMP}/apic-toolkit"
          mkdir -p "$APIC_HOME"
          tar -xzf toolkit/toolkit-linux.tgz -C "$APIC_HOME"

          # Find the binary (some builds put it in root, others under bin/)
          if   [ -x "${APIC_HOME}/apic" ];      then BIN="${APIC_HOME}"
          elif [ -x "${APIC_HOME}/bin/apic" ];  then BIN="${APIC_HOME}/bin"
          else
            echo "::error::Could not find 'apic' after extraction."
            find "$APIC_HOME" -maxdepth 2 -type f -name apic -ls || true
            exit 1
          fi

          # Make it available now AND for later steps
          export PATH="${BIN}:$PATH"
          echo "${BIN}"       >> "$GITHUB_PATH"           # for later steps
          echo "APIC_HOME=$APIC_HOME" >> "$GITHUB_ENV"
          echo "APIC_BIN=${BIN}/apic" >> "$GITHUB_ENV"

          # Accept license and show version using full path (works in this current step)
          "${BIN}/apic" --accept-license version

      - name: Normalize APIC server URL
        id: norm
        run: |
          set -euo pipefail
          # Strip trailing /manager if present
          BASE="${APIC_BASE%/manager}"
          echo "BASE=$BASE" >> "$GITHUB_ENV"
          echo "Using server: $BASE"

      - name: Login to APIC
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE_REALMS=()
          # 1) Respect explicit secret if provided
          if [ -n "${APIC_REALM:-}" ]; then
            CANDIDATE_REALMS+=("${APIC_REALM}")
          fi
          # 2) Try common SaaS defaults
          CANDIDATE_REALMS+=("provider/default-idp" "provider/default-idp-2" "provider/env9559876")
      
          OK=""
          for R in "${CANDIDATE_REALMS[@]}"; do
            echo "ðŸ” Trying realm: $R"
            if "$APIC_BIN" login \
                 --server   "${BASE}" \
                 --username "${APIC_USERNAME}" \
                 --password "${APIC_PASSWORD}" \
                 --realm    "$R" \
                 --accept-license; then
              echo "APIC_REALM=$R" >> "$GITHUB_ENV"
              OK="yes"
              break
            fi
            echo "Realm $R failed; trying next..."
          done
      
          if [ -z "$OK" ]; then
            echo "::error::Login failed for tested realms. Please verify the correct identity provider name in Manager > Administration > Identity providers (Provider context)."
            exit 1
          fi
      
          # Sanity check
          "$APIC_BIN" orgs:list --server "${BASE}" --accept-license | head -n 20 || true


      - name: Push draft API (create or update)
        run: |
          set -euo pipefail
          API_FILE="${{ github.event.inputs.api_file }}"
          if ! "$APIC_BIN" drafts:apis:create "${API_FILE}" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license ; then
            "$APIC_BIN" drafts:apis:update "${API_FILE}" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license
          fi

      - name: Push draft Product (create or update)
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          if ! "$APIC_BIN" drafts:products:create "${PRODUCT_FILE}" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license ; then
            "$APIC_BIN" drafts:products:update "${PRODUCT_FILE}" \
                --server "${BASE}" --org "${APIC_ORG}" --accept-license
          fi

      - name: Publish product to catalog (stage)
        run: |
          set -euo pipefail
          PRODUCT_FILE="${{ github.event.inputs.product_file }}"
          "$APIC_BIN" products:publish "${PRODUCT_FILE}" \
            --server "${BASE}" \
            --org "${APIC_ORG}" \
            --catalog "${APIC_CATALOG}" \
            --stage \
            --accept-license
